<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AsisLegal - Expedientes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; height: 100vh; overflow: hidden; display: flex; }
        .sidebar { width: 350px; background: white; border-right: 1px solid #dee2e6; display: flex; flex-direction: column; }
        .main { flex: 1; display: flex; flex-direction: column; background: #fff; }
        .chat-box { flex: 1; overflow-y: auto; padding: 20px; background: #f0f2f5; display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 80%; padding: 10px 15px; border-radius: 15px; }
        .user { align-self: flex-end; background: #0d6efd; color: white; }
        .bot { align-self: flex-start; background: white; border: 1px solid #ddd; }
        .item-doc { cursor: pointer; padding: 10px; border-bottom: 1px solid #eee; }
        .item-doc:hover { background: #f1f1f1; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="p-3 bg-primary text-white">
        <h5 class="m-0">AsisLegal ‚öñÔ∏è</h5>
    </div>
    <div class="p-3 border-bottom">
        <input type="file" id="fileInput" accept="application/pdf" class="d-none">
        <button onclick="document.getElementById('fileInput').click()" class="btn btn-outline-primary w-100">
            + Nuevo Expediente
        </button>
    </div>
    <div id="listContainer" class="flex-grow-1 overflow-auto">
        <div class="text-center mt-4 text-muted">Cargando...</div>
    </div>
</div>

<div class="main">
    <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-light">
        <h5 class="m-0" id="headerTitle">Bienvenido</h5>
        <div>
            <a id="btnDownload" href="#" target="_blank" class="btn btn-sm btn-secondary d-none">‚¨á Descargar PDF</a>
            <button id="btnAudio" class="btn btn-sm btn-warning d-none" onclick="playAudio()">üîä Escuchar</button>
        </div>
    </div>

    <div id="chatBox" class="chat-box">
        <div class="text-center mt-5 text-muted">
            <h3>Panel de Control Legal</h3>
            <p>Selecciona un expediente o sube uno nuevo.</p>
        </div>
    </div>

    <div class="p-3 border-top">
        <form id="chatForm" class="d-flex gap-2">
            <input type="text" id="msgInput" class="form-control" placeholder="Escribe tu consulta..." disabled>
            <button type="submit" id="btnSend" class="btn btn-primary" disabled>Enviar</button>
        </form>
    </div>
</div>

<script>
    // ==========================================
    // ‚öôÔ∏è CONFIGURACI√ìN NUEVA (Ruta cambiada)
    // ==========================================
    const API = 'http://127.0.0.1:8080/api'; 
    
    // Variables de estado
    let activeId = null;
    let currentAudio = null;

    // --- 1. INICIALIZAR ---
    document.addEventListener('DOMContentLoaded', () => {
        loadExpedientes();
    });

    // --- 2. CARGAR LISTA (GET /expedientes) ---
    async function loadExpedientes() {
        const list = document.getElementById('listContainer');
        try {
            // CAMBIO AQU√ç: Usamos /expedientes
            const res = await fetch(`${API}/expedientes`);
            const data = await res.json();

            if(data.data.length === 0) {
                list.innerHTML = '<div class="p-3 text-center text-muted">No hay expedientes.</div>';
                return;
            }

            list.innerHTML = data.data.map(item => `
                <div class="item-doc" onclick="openExpediente(${item.id_chat}, '${item.title}', ${item.id_document})">
                    <div class="fw-bold text-truncate">${item.title}</div>
                    <small class="text-muted">${new Date(item.created_at).toLocaleDateString()}</small>
                </div>
            `).join('');

        } catch (error) {
            console.error(error);
            list.innerHTML = '<div class="alert alert-danger m-2">Error de conexi√≥n (8080)</div>';
        }
    }

    // --- 3. SUBIR ARCHIVO (POST /expedientes) ---
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;

        const formData = new FormData();
        formData.append('pdf_file', file);
        formData.append('titulo', file.name.replace('.pdf', ''));

        document.getElementById('listContainer').innerHTML = '<div class="text-center mt-3 spinner-border text-primary"></div>';

        try {
            // CAMBIO AQU√ç: Usamos /expedientes
            const res = await fetch(`${API}/expedientes`, { method: 'POST', body: formData });
            const data = await res.json();
            
            if(data.status === 'success') {
                await loadExpedientes();
                openExpediente(data.data.id_chat, data.data.title, data.data.id_document);
            } else {
                alert('Error al subir');
                loadExpedientes();
            }
        } catch (error) {
            alert('Error de conexi√≥n al subir');
            loadExpedientes();
        }
    });

    // --- 4. ABRIR CHAT (GET /expedientes/{id}) ---
    async function openExpediente(id, title, docId) {
        activeId = id;
        document.getElementById('headerTitle').innerText = title;
        document.getElementById('msgInput').disabled = false;
        document.getElementById('btnSend').disabled = false;
        
        // Configurar bot√≥n descargar
        const btnDown = document.getElementById('btnDownload');
        btnDown.href = `${API}/documents/${docId}/download`;
        btnDown.classList.remove('d-none');

        const box = document.getElementById('chatBox');
        box.innerHTML = '<div class="text-center mt-5 spinner-border"></div>';

        try {
            // CAMBIO AQU√ç: Usamos /expedientes
            const res = await fetch(`${API}/expedientes/${id}`);
            const data = await res.json();
            renderMessages(data.data.messages || []);
        } catch (error) {
            box.innerHTML = '<div class="text-center text-danger">Error cargando chat</div>';
        }
    }

    // --- 5. ENVIAR MENSAJE (POST /expedientes/{id}/mensaje) ---
    document.getElementById('chatForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('msgInput');
        const text = input.value.trim();
        if(!text || !activeId) return;

        addBubble(text, 'user');
        input.value = '';
        input.disabled = true;

        // Loading
        const box = document.getElementById('chatBox');
        const loadId = 'loading-' + Date.now();
        box.innerHTML += `<div id="${loadId}" class="message bot"><em>ü§ñ Analizando...</em></div>`;
        box.scrollTop = box.scrollHeight;

        try {
            // CAMBIO AQU√ç: Usamos /expedientes
            const res = await fetch(`${API}/expedientes/${activeId}/mensaje`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: text })
            });
            const data = await res.json();
            document.getElementById(loadId).remove();

            if(data.status === 'success') {
                addBubble(data.ai_message.content, 'bot');
                currentAudio = data.audio_base64;
                const btnAudio = document.getElementById('btnAudio');
                if(currentAudio) btnAudio.classList.remove('d-none');
                else btnAudio.classList.add('d-none');
            } else {
                addBubble('Error en la IA', 'bot');
            }
        } catch (error) {
            document.getElementById(loadId).remove();
            addBubble('Error de red', 'bot');
        } finally {
            input.disabled = false;
            input.focus();
        }
    });

    function addBubble(text, type) {
        const box = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerHTML = text.replace(/\n/g, '<br>');
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function renderMessages(msgs) {
        const box = document.getElementById('chatBox');
        box.innerHTML = '';
        if(msgs.length === 0) {
            box.innerHTML = '<div class="text-center mt-5 text-muted">Inicia la conversaci√≥n.</div>';
            return;
        }
        msgs.forEach(m => addBubble(m.content, m.sender === 'user' ? 'user' : 'bot'));
        box.scrollTop = box.scrollHeight;
    }

    function playAudio() {
        if(currentAudio) new Audio("data:audio/mp3;base64," + currentAudio).play();
    }
</script>

</body>
</html>
